name: ðŸš€ CI/CD Pipeline - Automated Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  backend-tests:
    name: ðŸ Backend Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-django pytest-cov bandit flake8
    
    - name: ðŸ”§ Setup Django
      run: |
        cd backend
        python manage.py collectstatic --noinput
        python manage.py migrate
      env:
        DATABASE_URL: postgres://test:test@localhost:5432/testdb
        DJANGO_SETTINGS_MODULE: backend_project.settings
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: False
    
    - name: ðŸ§ª Run Django Tests
      run: |
        cd backend
        python manage.py test --verbosity=2
      env:
        DATABASE_URL: postgres://test:test@localhost:5432/testdb
        DJANGO_SETTINGS_MODULE: backend_project.settings
        SECRET_KEY: test-secret-key-for-ci
    
    - name: ðŸ”’ Security Analysis
      run: |
        cd backend
        bandit -r apps/ -f json -o bandit-report.json || true
        
    - name: ðŸ“Š Code Quality Check
      run: |
        cd backend
        flake8 apps/ --count --select=E9,F63,F7,F82 --show-source --statistics
    
    - name: ðŸ“¤ Upload Backend Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-reports
        path: |
          backend/bandit-report.json
          backend/coverage.xml

  frontend-tests:
    name: âš›ï¸ Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: ðŸ“¦ Install dependencies
      run: |
        cd frontend
        npm ci
    
    - name: ðŸ” ESLint Check
      run: |
        cd frontend
        npm run lint
    
    - name: ðŸ§ª Unit Tests
      run: |
        cd frontend
        npm run test:unit
    
    - name: ðŸ”’ Security Audit
      run: |
        cd frontend
        npm audit --audit-level moderate || true
    
    - name: ðŸ—ï¸ Build Test
      run: |
        cd frontend
        npm run build
      env:
        CI: false
    
    - name: ðŸ“¤ Upload Coverage
      uses: actions/upload-artifact@v4
      with:
        name: frontend-coverage
        path: frontend/coverage/

  e2e-tests:
    name: ðŸŒ E2E Tests
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: ðŸ“¦ Install dependencies
      run: |
        pip install -r requirements.txt
        cd frontend && npm ci
    
    - name: ðŸš€ Start Backend
      run: |
        cd backend
        python manage.py migrate
        python manage.py collectstatic --noinput
        python manage.py runserver &
        sleep 10
      env:
        DJANGO_SETTINGS_MODULE: backend_project.settings
        SECRET_KEY: test-secret-key-for-ci
    
    - name: ðŸš€ Start Frontend
      run: |
        cd frontend
        npm start &
        sleep 30
      env:
        CI: false
    
    - name: ðŸŒ Run Cypress Tests
      run: |
        cd frontend
        npm run cypress:run:headless
      env:
        CYPRESS_baseUrl: http://localhost:3000
    
    - name: ðŸ“¤ Upload E2E Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-reports
        path: |
          frontend/cypress/reports/
          frontend/cypress/screenshots/
          frontend/cypress/videos/

  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: ðŸ“¤ Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  performance-test:
    name: âš¡ Performance Test
    runs-on: ubuntu-latest
    needs: [frontend-tests]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: ðŸ“¦ Install Lighthouse CI
      run: npm install -g @lhci/cli@0.12.x
    
    - name: ðŸ—ï¸ Build Frontend
      run: |
        cd frontend
        npm ci
        npm run build
    
    - name: ðŸš€ Serve Frontend
      run: |
        cd frontend
        npx serve -s build -l 3000 &
        sleep 10
    
    - name: âš¡ Run Lighthouse CI
      run: lhci autorun
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  integration-report:
    name: ðŸ“Š Integration Report
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests]
    if: always()
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ“¥ Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: ðŸ“Š Generate Integration Report
      run: |
        echo "# ðŸš€ CI/CD Test Report" > report.md
        echo "" >> report.md
        echo "## ðŸ“ˆ Test Results Summary" >> report.md
        echo "" >> report.md
        echo "| Component | Status |" >> report.md
        echo "|-----------|---------|" >> report.md
        
        # Backend status
        if [ "${{ needs.backend-tests.result }}" == "success" ]; then
          echo "| Backend Tests | âœ… Passed |" >> report.md
        else
          echo "| Backend Tests | âŒ Failed |" >> report.md
        fi
        
        # Frontend status  
        if [ "${{ needs.frontend-tests.result }}" == "success" ]; then
          echo "| Frontend Tests | âœ… Passed |" >> report.md
        else
          echo "| Frontend Tests | âŒ Failed |" >> report.md
        fi
        
        # E2E status
        if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
          echo "| E2E Tests | âœ… Passed |" >> report.md
        else
          echo "| E2E Tests | âŒ Failed |" >> report.md
        fi
        
        echo "" >> report.md
        echo "Generated at: $(date)" >> report.md
        
        cat report.md
    
    - name: ðŸ“¤ Upload Integration Report
      uses: actions/upload-artifact@v4
      with:
        name: integration-report
        path: report.md
    
    - name: ðŸ’¬ Comment PR
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          }); 